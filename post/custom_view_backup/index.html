<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è‡ªå®šä¹‰Viewå‚¨å¤‡çŸ¥è¯† | Grinofith&#39;s Blog</title>
<link rel="shortcut icon" href="https://kanyewestforreal.github.io//favicon.ico?v=1741497022322">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://kanyewestforreal.github.io//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="è‡ªå®šä¹‰Viewå‚¨å¤‡çŸ¥è¯† | Grinofith&#39;s Blog - Atom Feed" href="https://kanyewestforreal.github.io//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="é’ˆå¯¹äºä¸Šä¸€æ¬¡è®²è¿°äº†ä¸€äº›è‡ªå®šä¹‰Viewæ¯”è¾ƒå…³é”®çš„APIï¼Œä»¥åŠå¼•ç”Ÿå‡ºæ¥çš„é—®é¢˜ï¼ˆç›´æ¥åœ¨Activityä¸­ç»˜åˆ¶ï¼‰ã€‚
è¿™å¯èƒ½æ˜¯å‰ç¼€çŸ¥è¯†çŸ¥è¯†æ²¡æœ‰è¡¥å……çš„å…³ç³»ï¼Œæ‰€ä»¥è¿™ç¯‡ç¬”è®°ä¸»è¦è®°å½•è®°å½•ä¸€äº›è‡ªå®šä¹‰Viewçš„åº•å±‚çŸ¥è¯†ã€‚
å¼•å…¥ï¼šä»Actvityä»‹ç»Viewçš„æ¸²æŸ“..." />
    <meta name="keywords" content="Android" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <!-- <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script> -->
    <script src="/media/js/highlight/highlight.min.js"></script>
    <script src="/media/js/sroll_markdown_titile_list.js"></script>
    <link rel="stylesheet" type="text/css" href="/media/js/highlight/styles/atom-one-dark.css">
    <script>hljs.highlightAll();</script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://kanyewestforreal.github.io/">
  <img class="avatar" src="https://kanyewestforreal.github.io//images/avatar.png?v=1741497022322" alt="">
  </a>
  <h1 class="site-title">
    Grinofith&#39;s Blog
  </h1>
  <p class="site-description">
    The key is seriously reflecting.
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              è‡ªå®šä¹‰Viewå‚¨å¤‡çŸ¥è¯†
            </h2>
            <div class="post-info">
              <span>
                2023-05-08
              </span>
              <span>
                9 min read
              </span>
              
                <a href="https://kanyewestforreal.github.io/tag/AndroidTAG/" class="post-tag">
                  # Android
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://kanyewestforreal.github.io//post-images/custom_view_backup.jpeg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <p>é’ˆå¯¹äºä¸Šä¸€æ¬¡è®²è¿°äº†ä¸€äº›<code>è‡ªå®šä¹‰View</code>æ¯”è¾ƒå…³é”®çš„APIï¼Œä»¥åŠå¼•ç”Ÿå‡ºæ¥çš„é—®é¢˜ï¼ˆç›´æ¥åœ¨Activityä¸­ç»˜åˆ¶ï¼‰ã€‚</p>
<p>è¿™å¯èƒ½æ˜¯å‰ç¼€çŸ¥è¯†çŸ¥è¯†æ²¡æœ‰è¡¥å……çš„å…³ç³»ï¼Œæ‰€ä»¥è¿™ç¯‡ç¬”è®°ä¸»è¦è®°å½•è®°å½•ä¸€äº›è‡ªå®šä¹‰Viewçš„åº•å±‚çŸ¥è¯†ã€‚</p>
<h2 id="å¼•å…¥ä»actvityä»‹ç»viewçš„æ¸²æŸ“"><strong>å¼•å…¥ï¼šä»Actvityä»‹ç»Viewçš„æ¸²æŸ“</strong></h2>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦æ˜ç™½ä¸€ä¸ªViewæ˜¯å¦‚ä½•æ¸²æŸ“åˆ°Activityä¸Šçš„ï¼Œé‚£ä¹ˆå°±ä¸å¯é¿å…çš„éœ€è¦å»è§£æActivityçš„æºç ï¼Œåœ¨è¿™é‡Œä¸»è¦è¿˜æ˜¯éœ€è¦å»çœ‹çœ‹å…³äºViewéƒ¨åˆ†çš„ï¼Œå…¶ä»–éƒ¨åˆ†å¯ä»¥ç”±å¤§å®¶æ¥ä¸€èµ·åˆ†äº«ã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œå¤§éƒ¨åˆ†<code>Activity</code>è¿˜æ˜¯ä¼šé€‰æ‹©ç»§æ‰¿<code>AppCompatActivity</code>ï¼ˆä»¥ä¸‹ç®€ç§°ACAå§ï¼‰ï¼Œä½œä¸ºå‘ä¸‹å…¼å®¹çš„é€‰æ‹©ã€‚åœ¨å®é™…ä¸­ï¼ŒActivityå’ŒACAçš„ä»£ç è¿˜æ˜¯æœ‰éƒ¨åˆ†å·®å¼‚ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†é€‚é…ä½ç‰ˆæœ¬ã€‚</p>
<p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥å…ˆç”¨Android Studioçš„å·¥å…·å¼€çœ‹çœ‹ï¼Œæˆ‘ä»¬æ‰€è§çš„å±å¹•åˆ†ä¸ºä»€ä¹ˆå±‚æ¬¡ã€‚</p>
<p>ä½¿ç”¨<code>LayoutInspector</code>ï¼Œåˆ†æç»§æ‰¿<code>AppCompatActivity</code>çš„è§†å›¾ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://kanyewestforreal.github.io//post-images/1684153328447.png" alt="" loading="lazy"></figure>
<p>ä½¿ç”¨<code>LayoutInspector</code>ï¼Œåˆ†æç»§æ‰¿<code>Activity</code>çš„è§†å›¾ï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://kanyewestforreal.github.io//post-images/1684153351564.png" alt="" loading="lazy"></figure>
<p>è¿™è¾¹å¯¹æ¯”åˆ†æçœ‹äº†ä¸‹ï¼Œéƒ½å‘ç°è§†å›¾æœ€å¤–å±‚è¿˜æ˜¯DecorViewã€‚è¾¨æä¸€ä¸‹ACAçš„ä¸åŒä¹‹å¤„ï¼š</p>
<ol>
<li>ç¬¬å››å±‚å¼€å§‹ä¸ä¸€æ ·ï¼Œæ˜¯ä¸€ä¸ªidä¸º<code>action_bar_root</code>çš„<code>FitWindowsLinearLayout</code>çš„ä¸œè¥¿ã€‚çœ‹åå­—ä¹Ÿæ˜¯<code>LinearLayout</code>ã€‚</li>
<li>ç¬¬äº”å±‚æœ‰ä¸€å®šç›¸ä¼¼ä¹‹å¤„ï¼Œidä¸º<code>action_mode_bar_stub</code>ç±»å‹çš„<code>ViewStubCompat</code>å’ŒActivityç¬¬ä¸‰å±‚idä¸º<code>action_mode_bar_stub</code>ç±»å‹çš„<code>ViewStub</code>ã€‚ä¸‹é¢çš„å¸ƒå±€æ˜¯<code>ContentFrameLayout</code>ï¼Œæ¯«æ— ç–‘é—®ä¹Ÿæ˜¯<code>FrameLayout</code>çš„å­ç±»ï¼Œå’ŒActivityçš„ç¬¬ä¸‰å±‚ä¸€è‡´ï¼Œå®ƒçš„idæ˜¯**<code>content</code>****ã€‚**</li>
<li>ç¬¬å…­å±‚å°±æ˜¯è‡ªå·±çš„XMLã€‚</li>
</ol>
<p>ç°åœ¨å†™çš„Ativityå‡ ä¹éƒ½æ˜¯ç»§æ‰¿<code>AppCompatActivity</code>çš„ï¼Œä½œç”¨æ˜¯ä¸ºäº†å…¼å®¹ã€‚å¤§å®¶å¯èƒ½å·²ç»å‘ç°<code>AppCompatActivity</code>çš„<code>setContentView</code>æ–¹æ³•ç‚¹è¿›å»å’ŒActivityçš„ä¸åŒï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜æ˜¯å¤§ç›¸å¾„åº­çš„ã€‚</p>
<p>Activityï¼š<br>
<img src="https://kanyewestforreal.github.io//post-images/1684153511765.png" alt="" loading="lazy"></p>
<p>AppCompatActivityï¼š<br>
<img src="https://kanyewestforreal.github.io//post-images/1684153506174.png" alt="" loading="lazy"></p>
<p><strong>æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹ï¼Œ<strong><strong><code>Activityçš„setContentView</code><strong><strong>ä½œä¸ºä¸€ä¸ªåŸºç¡€ï¼Œå†å»çœ‹çœ‹</strong></strong><code>ACAçš„setContentView</code></strong></strong>ã€‚</strong></p>
<p>ä¸»è¦å…ˆçœ‹å®ƒçš„ç¬¬ä¸€è¡Œï¼Œç¬¬äºŒè¡Œæ˜æ˜¾æ˜¯è®¾ç½®ä¸€ä¸ªçŠ¶æ€æ çš„ï¼Œæš‚ä¸”ä¸ç®¡ã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://kanyewestforreal.github.io//post-images/1684153530044.png" alt="" loading="lazy"></figure>
<p>getWindowæ–¹æ³•è¿”å›äº†ä¸€ä¸ªWindowå¯¹è±¡ï¼Œè¿™ä¸ªWindowå¯¹è±¡å®é™…ä¸Šæ˜¯åœ¨Activityçš„attachä¸­ç»‘å®šçš„ã€‚</p>
<p>æƒ³è¦äº†è§£Viewæ˜¯å¦‚ä½•ç»˜åˆ¶åœ¨Activityå‰ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œå¯åŠ¨ä¸€ä¸ªActivityçš„è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ã€‚</p>
<p>Activitythreadçš„<code>scheduleLaunchActivity</code>æ–¹æ³•è´Ÿè´£å¯åŠ¨Activityï¼Œç»è¿‡Handleå¤„ç†æ‰§è¡Œåˆ°<code>handleLaunchActivity</code></p>
<pre><code class="language-Java">Activity a = performLaunchActivity(r, customIntent);

//è¿™é‡Œé¢æ‰§è¡Œäº†Activity.onResume()
handleResumeActivity(r.token, false, r.isForward,!r.activity.mFinished &amp;&amp; !r.startsNotResumed);
</code></pre>
<p><code>performLaunchActivity</code>ä¼šåˆ›å»ºå¾…å¯åŠ¨Activityç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶attachæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨Activityçš„<code>onCreate</code>,<code>onStart</code>ç­‰æ–¹æ³•ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°<code>mWindow</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ª<code>PhoneWindow</code>ç±»å‹ï¼Œå…¶æ˜¯<code>Window</code>çš„ä¸€ä¸ªå®ç°ç±»ã€‚mWindowåˆ›å»ºå®ä¾‹åï¼Œå°†å½“å‰Activityå½“å›è°ƒè®¾ç½®äº†è¿›å»ï¼Œä¸»è¦ç”¨äºä¸€äº›äº‹ä»¶çš„å›è°ƒå¤„ç†ã€‚</p>
<figure data-type="image" tabindex="4"><img src="https://kanyewestforreal.github.io//post-images/1684153601588.png" alt="" loading="lazy"></figure>
<p>éšåï¼Œ<code>setWindowManager</code>ä¸»è¦æ˜¯è·å¾—<code>ç³»ç»Ÿçš„ WindowManager</code>ï¼Œç„¶åä¼ ç»™<code> PhoneWindow</code> ï¼Œæœ€ç»ˆï¼Œåœ¨ <code>PhoneWindow</code> ä¸­æŒæœ‰äº†ä¸€ä¸ª <code>WindowManagerImpl</code> ï¼ˆWindowManagerä¹Ÿæ˜¯æŠ½è±¡ç±»ï¼Œå…¶å®ç°ç±»æ˜¯WMIï¼‰çš„å¼•ç”¨ã€‚</p>
<figure data-type="image" tabindex="5"><img src="https://kanyewestforreal.github.io//post-images/1684153628482.png" alt="" loading="lazy"></figure>
<p>ç”±äº<code>Window</code>çš„çœŸæ­£å®ç°ç±»å‹æ˜¯PWï¼Œä¹Ÿå°±æ˜¯å®ƒè°ƒç”¨äº†<code>setContentView</code>æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†å»çœ‹çœ‹PWçš„å…·ä½“ä»£ç ã€‚</p>
<figure data-type="image" tabindex="6"><img src="https://kanyewestforreal.github.io//post-images/1684153684844.png" alt="" loading="lazy"></figure>
<p>åœ¨PWçš„<code>setContentView</code>æ–¹æ³•ä¸­ï¼Œçœ‹åˆ°äº†<code>mContentParent</code>è¿™ä¸ªå˜é‡ï¼Œå—¯ï¼Ÿè¿™ä¸ªå˜é‡åæ˜¯å¦æœ‰äº›çœ¼ç†Ÿã€‚</p>
<figure data-type="image" tabindex="7"><img src="https://kanyewestforreal.github.io//post-images/1684153734096.png" alt="" loading="lazy"></figure>
<p><img src="https://kanyewestforreal.github.io//post-images/1684153770806.png" alt="" loading="lazy"><br>
å¥½å®¶ä¼™ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥çŒœæµ‹ï¼Œ<code>mContentParent</code>è¿™ç©æ„å®é™…ä¸Šå°±æ˜¯åˆ†æè§†å›¾ä¸­çš„<code>FrameLayoutå¸ƒå±€</code>ï¼ŒåŒæ—¶ç”±ç¬¬äºŒå¤„å…³é”®ä»£ç ç‚¹å¾—çŸ¥ï¼Œæˆ‘ä»¬ä¼ å…¥çš„layoutIDè¢«è§£æè¿›å…¥<code>mContentParent</code>ã€‚é‚£ä¹ˆæˆ‘ä»¬å†è®¤çœŸçœ‹çœ‹æºç è®ºè¯ä¸€ä¸‹ã€‚æˆ‘ä»¬å®é™…å‘ç°<code>mContentParent</code>çš„åˆ›å»ºæ˜¯åœ¨<code>installDecor</code>æ–¹æ³•é‡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±çœ‹çœ‹<code>installDecor</code>æ–¹æ³•ã€‚<br>
<img src="https://kanyewestforreal.github.io//post-images/1684153852143.png" alt="" loading="lazy"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>mContentParent</code>æ˜¯ç”±<code>generateLayout</code>æ–¹æ³•åˆ›å»ºï¼Œå…¶ä¸­ä¼ å…¥äº†<code>mDecor</code>, è€Œ<code>mDecor</code>ç”±<code>generateDecor</code>ç”Ÿæˆï¼Œæ˜¯<code>DecorView</code>ç±»å‹ã€‚</p>
<p><img src="https://kanyewestforreal.github.io//post-images/1684153842198.png" alt="" loading="lazy"><br>
åˆ°è¿™é‡Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„Activityçš„attachæ–¹æ³•é‡Œç»‘å®šäº†ä¸€ä¸ª<code>Window</code>, ä¹Ÿå°±æ˜¯<code>PhoneWindow</code>ã€‚åŒæ—¶åœ¨PWé‡Œé¢ä¼šåˆ›å»ºä¸€ä¸ª<code>DecorView</code>ï¼Œç„¶å<code>DecorView</code>è°ƒç”¨<code>setWindow</code>ç»‘å®š<code>Window</code>ï¼Œä¹‹åæ ¹æ®ä¸åŒfeaturesæ¥é€‰æ‹©ä¸åŒå®¹å™¨ï¼Œæ¥åˆå§‹åŒ–<code>mContentParent</code>ã€‚</p>
<figure data-type="image" tabindex="8"><img src="https://kanyewestforreal.github.io//post-images/1684153920220.png" alt="" loading="lazy"></figure>
<ul>
<li>è¿™é‡Œçš„idå¸¸é‡<code>ID_ANDROID_CONTENT</code>ç‚¹å‡»å»å¯ä»¥çœ‹åˆ°å®šä¹‰ä¸º<code>com.android.internal.R.id.content </code>æ‰€ä»¥<code>mContentParent</code>å°±æ˜¯ä»¬çš„<strong>ç¬¬ä¸‰å±‚</strong>idä¸º<code>content</code>çš„å¸§å¸ƒå±€ã€‚</li>
<li>è¿™é‡Œ<code>findViewById</code>å…¶å®å°±æ˜¯ä»<code>DecorView</code>ä¸­æŸ¥æ‰¾</li>
</ul>
<p>ç°åœ¨å¯ä»¥æ€»ç»“å‡ºä¸€ä¸ªå›¾ç‰‡å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼Œ<br>
<img src="https://kanyewestforreal.github.io//post-images/1684153935029.png" alt="" loading="lazy"></p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å¤§æ¦‚ä¼šæ˜æ‚Ÿï¼ŒActivityå¹¶ä¸æ˜¯ä½œä¸ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ°çš„è§†å›¾å­˜åœ¨ï¼Œä»–è´Ÿè´£çš„æ˜¯æŸäº›æ“ä½œå’Œå›è°ƒçš„æ§åˆ¶ï¼Œç»‘å®šä¸€ä¸ª<code>PhoneWindow</code>, è€Œæˆ‘ä»¬èƒ½çœ‹åˆ°çš„æœ€é¡¶å±‚è§†å›¾<code>DecorView</code>å°±æ˜¯ä¾é™„åœ¨<code>PhoneWindow</code>ä¸Šã€‚</p>
<p><em><strong>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç›´æ¥åœ¨Activityä¸­ç»˜åˆ¶Viewï¼Œå¦‚æœä¸æ·»åŠ è¿›å…¥Windowä¸­ï¼Œä»€ä¹ˆä¹Ÿä¸ä¼šæ˜¾ç¤ºçš„åŸå› ã€‚</strong></em></p>
<p>ä¸è¿‡ï¼Œå…¶å®è¿™æ—¶å€™DecorViewæ˜¯å¹¶æ²¡æœ‰è¢«æ·»åŠ è¿›å…¥Windowä¸­çš„ï¼Œè™½ç„¶è¯´ç»‘å®šäº†Windowï¼Œä½†æ˜¯è¦åœ¨<code>Activity#onResume</code>ä¸­æ‰ä¼šå˜å¾—å¯è§ã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆDecorViewåœ¨onResume()ä¹‹åæ‰å¯¹ç”¨æˆ·å¯è§å‘¢ï¼Ÿä¸ºä»€ä¹ˆDecorViewç»‘å®šäº†Windowå´ä¸æ·»åŠ è¿›WIndowï¼Œéœ€è¦åé¢WindowManageræ·»åŠ å‘¢ï¼Ÿ<br>
è¯·è¯¦ç»†æ€è€ƒè¿™ä¸¤ä¸ªé—®é¢˜ï¼Œåœ¨æœ€åä¼šè¿›è¡Œè¡¥å……ã€‚</p>
</blockquote>
<h2 id="æ·±å…¥viewçš„å‘ˆç°æµç¨‹">æ·±å…¥ï¼šViewçš„å‘ˆç°æµç¨‹</h2>
<figure data-type="image" tabindex="9"><img src="https://kanyewestforreal.github.io//post-images/1684153972014.png" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹Activityçš„onRemuneå…·ä½“æ‰§è¡Œçš„æ–¹æ³•ï¼Œé‡Œé¢æœ€å…³é”®çš„æ˜¯<code>wm.addView(decor, l)</code>;</p>
<p>å…¶ä¸­wmæ˜¯ViewManagerä¸€ä¸ªæ¥å£ï¼Œç”±<code>WindowManager</code>å®ç°ï¼Œ<code>WindowManager</code>çš„å®ç°åˆæ˜¯<code>WindowManagerImpl</code>ï¼Œä½†æ˜¯WMIçš„å®é™…å®ç°åˆæ˜¯äº¤ç»™<code>WindowManagerGlobal</code>å»å¤„ç†ã€‚<code>WindowMangerGlobal </code>æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªå¯¹è±¡</p>
<figure data-type="image" tabindex="10"><img src="https://kanyewestforreal.github.io//post-images/1684154146446.png" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨WMGçš„ <code>addView</code> æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæœ€å…³é”®çš„<code>ViewRootImpl</code>å¯¹è±¡ï¼Œç„¶åé€šè¿‡<code> ViewRootImpl çš„ setView æ–¹æ³•</code>å°† DecorView æ·»åŠ åˆ° WMS ä¸­ã€‚</p>
<figure data-type="image" tabindex="11"><img src="https://kanyewestforreal.github.io//post-images/1684154166380.png" alt="" loading="lazy"></figure>
<p>åœ¨setViewæ–¹æ³•ä¸­</p>
<pre><code class="language-Java">public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView,
   int userId) {
       ...
       requestLayout();
       ...
       try {
       mWindowSession res =                         mWindowSession.addToDisplayAsUser(mWindow, mSeq, mWindowAttributes, getHostVisibility(), mDisplay.getDisplayId(), userId, mTmpFrame, mAttachInfo.mContentInsets, mAttachInfo.mStableInsets, mAttachInfo.mDisplayCutout, inputChannel, mTempInsets, mTempControls);setFrame(mTmpFrame); } 
   }

@Override 
public void requestLayout() { 
    if (!mHandlingLayoutInLayoutRequest){ 
         checkThread();
         mLayoutRequested = true; 
         scheduleTraversals(); 
     }
  }
</code></pre>
<p>å…ˆæ˜¯åšäº†ä¸ªåˆ·æ–°å¸ƒå±€çš„æ“ä½œï¼Œå†…éƒ¨æ‰§è¡Œçš„<code>scheduleTraversals()</code> å°±æ˜¯Viewç»˜åˆ¶çš„å…¥å£ï¼Œè°ƒç”¨æ­¤æ–¹æ³•å <code>ViewRootImpl </code>æ‰€å…³è”çš„ View <strong>æ‰§è¡Œ</strong> <code>measure - layout - draw </code>æ“ä½œï¼Œç¡®ä¿åœ¨ View è¢«æ·»åŠ åˆ° Window ä¸Šæ˜¾ç¤ºåˆ°å±å¹•ä¹‹å‰ï¼Œå·²ç»å®Œæˆæµ‹é‡å’Œç»˜åˆ¶æ“ä½œã€‚</p>
<figure data-type="image" tabindex="12"><img src="https://kanyewestforreal.github.io//post-images/1684154393866.png" alt="" loading="lazy"></figure>
<p>è‡³æ­¤ç”±<code>ViewRootImpl</code>å®Œæˆäº†<strong>æ·»åŠ Viewåˆ°Window</strong>çš„æ“ä½œã€‚ ç„¶åå°†è°ƒç”¨<code>mWindowSession</code>çš„<code>addToDisplayAsUser</code>æ–¹æ³•æ¥å®Œæˆ<strong>Windowçš„æ·»åŠ è¿‡ç¨‹</strong>ï¼Œå†…éƒ¨çœŸå®æ‰§è¡Œçš„åœ°æ–¹åœ¨<strong>WMSï¼ˆWindowManagerService).</strong></p>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬é‡åˆ°ä¸€ä¸ªæ–°çš„ViewRootImplç±»ï¼Œå®ƒå°†DecorViewå’ŒPhoneWindow<em><strong>ç»„åˆ</strong></em>èµ·æ¥ï¼ˆä¹‹å‰çš„**<code>DecorVIew#setWindow</code><strong><strong>æ–¹æ³•å®é™…ä¸Šæ˜¯å¯ä»¥</strong></strong><code>getWindow</code>**<strong>çš„å‰æï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸º<em><strong><strong>ç»‘å®š</strong></strong></em>èµ·æ¥</strong>ï¼‰ã€‚åŒæ—¶æˆ‘ä»¬éœ€è¦æ˜ç¡®çš„æ˜¯ï¼ŒViewRootImplæ˜¯æ•´ä¸ªVewTreeçš„ç®¡ç†è€…ï¼Œä¸æ˜¯ViewTreeå…¶ä¸­çš„æ ¹ç»“ç‚¹æˆ–è€…ä¸€å‘˜ã€‚ViewRootImpl æ˜¯ DecorView çš„ parentï¼Œä½†æ˜¯ä»–å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„ Viewï¼Œåªæ˜¯ç»§æ‰¿äº† ViewParent æ¥å£ï¼Œç”¨æ¥æŒç®¡ View çš„å„ç§äº‹ä»¶ï¼ŒåŒ…æ‹¬<code> requestLayout</code>ã€<code>invalidate</code>ã€<code>dispatchInputEvent </code>ç­‰ç­‰ã€‚</p>
<blockquote>
<p>ViewTreeçš„æ¦‚å¿µ</p>
<figure data-type="image" tabindex="13"><img src="https://kanyewestforreal.github.io//post-images/1684154186111.png" alt="" loading="lazy"></figure>
</blockquote>
<h2 id="å›æ‰£acaä¸‹viewçš„æ¸²æŸ“">å›æ‰£ï¼šACAä¸‹Viewçš„æ¸²æŸ“</h2>
<p>æˆ‘ä»¬ä¸»è¦è¿˜æ˜¯çœ‹çœ‹ACAç±»ä¸­çš„setContentViewè¿™ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­<code>getDelegate()</code>æ–¹æ³•æ˜¯éœ€è¦é‡è§†ï¼ŒDelegateçš„ä¸­æ–‡æ„æ€æ˜¯ä»£ç†ã€ä»£è¡¨ï¼Ÿï¼è¿™æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå¾ˆå®¹æ˜“è®©æˆ‘è”æƒ³åˆ°ä¹‹å‰åœ¨Retrofitä¸­äº†è§£åˆ°çš„ä»£ç†æ¨¡å¼ï¼Œç‚¹è¿›å»çœ‹çœ‹ã€‚</p>
<figure data-type="image" tabindex="14"><img src="https://kanyewestforreal.github.io//post-images/1684154248928.png" alt="" loading="lazy"></figure>
<p><strong>XXX.createæ˜¯ä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰ï¼Œè¿™å°±æ˜¯ä¹‹å‰ä»‹ç»Retrofitçš„ä¸­ä»£ç†æ¨¡å¼å•Šã€‚</strong></p>
<p>å†çœ‹çœ‹createè¿”å›äº†<code>AppCompatDelegateImpl</code>å¯¹è±¡</p>
<figure data-type="image" tabindex="15"><img src="https://kanyewestforreal.github.io//post-images/1684154254437.png" alt="" loading="lazy"></figure>
<p>è¿›å…¥<code>AppCompatDelegateImpl</code>é‡Œçœ‹çœ‹ï¼Œå’ŒActivityå†…éƒ¨ä¸€æ ·ï¼Œæœ‰ä¸€ç³»åˆ—çš„setContentViewæ–¹æ³•é‡è½½ï¼Œä¸»è¦çœ‹çœ‹æ˜¯åŠ è½½XMLæ–‡ä»¶çš„æ–¹æ³•ã€‚</p>
<figure data-type="image" tabindex="16"><img src="https://kanyewestforreal.github.io//post-images/1684154261481.png" alt="" loading="lazy"></figure>
<p>è¿™ä¸ªæ–¹æ³•é‡Œå®ç°äº†ä¸‰ä»¶äº‹ï¼š</p>
<ul>
<li><code>ensureSubDecor</code>å¯ä»¥çŒœæµ‹æ˜¯å¯¹å­DecorViewè¿›è¡Œåˆ›å»ºåˆå§‹åŒ–ã€‚</li>
<li><strong>æ‰¾åˆ°idä¸ºcontentçš„å®¹å™¨ï¼Œæ¸…ç©ºåŸæ¥å­View,æŠŠæˆ‘ä»¬å†™çš„<strong><strong>XML</strong></strong>æ·»åŠ è¿›å»</strong>ï¼ˆ<strong>æ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Ÿ</strong>ï¼‰</li>
<li>æ‰§è¡ŒActivityçš„<code>onContentChanged</code>å›è°ƒã€‚</li>
</ul>
<p>æˆ‘ä»¬ä¸»è¦è¿˜æ˜¯çœ‹çœ‹<code>ensureSubDecor</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­æ¯”è¾ƒå…³é”®çš„è¿˜å¾—çœ‹çœ‹<code>createSubDecor</code>æ–¹æ³•ã€‚</p>
<figure data-type="image" tabindex="17"><img src="https://kanyewestforreal.github.io//post-images/1684154420481.png" alt="" loading="lazy"></figure>
<p>è¿›å…¥<code>createSubDecor</code>æ–¹æ³•åï¼Œæˆ‘ä»¬å…ˆåˆ†æå‰åŠéƒ¨åˆ†ï¼Œåœ¨é‡ç‚¹æ ‡æ³¨å‰ï¼Œéƒ½æ˜¯å¯¹WIndowæ ·å¼çš„ä¸€äº›å¤„ç†ï¼Œæ‰€ä»¥è¿˜æ˜¯çœ‹è“è‰²æ ‡æ³¨å¤„ã€‚</p>
<figure data-type="image" tabindex="18"><img src="https://kanyewestforreal.github.io//post-images/1684154430969.png" alt="" loading="lazy"></figure>
<p>ensureWindowæ–¹æ³•å®é™…ä¸Šæ˜¯ç»™Activityç»‘å®šPWï¼Œä¹Ÿæ˜¯ç»™mWindowåˆå§‹åŒ–PWã€‚</p>
<p>æˆ‘ä»¬å°±çŸ¥é“æ¥ä¸‹æ¥å’ŒActivityç±»ä¼¼äº†ï¼ŒgetDecorViewæ–¹æ³•ï¼Œå®é™…ä¸Šè°ƒç”¨äº†insatllDeocorã€‚</p>
<figure data-type="image" tabindex="19"><img src="https://kanyewestforreal.github.io//post-images/1684154525568.png" alt="" loading="lazy"></figure>
<p>AppCompatActivityçš„setContentViewæ–¹æ³•è™½ç„¶ç°åœ¨æ²¡æœ‰è°ƒç”¨PhoneWindowçš„setContentæ–¹æ³•ï¼Œä½†æ˜¯å´æŠŠä»–çš„æ ¸å¿ƒä»£ç installDecor() å…ˆç»™æ‰§è¡Œäº†ã€‚</p>
<p>ä¸Šé¢çœ‹å®Œäº†ensureSubDecorçš„å‰åŠéƒ¨åˆ†ä»£ç ï¼Œæˆ‘ä»¬å†æ¥çœ‹ååŠéƒ¨åˆ†ã€‚</p>
<figure data-type="image" tabindex="20"><img src="https://kanyewestforreal.github.io//post-images/1684154548009.png" alt="" loading="lazy"></figure>
<p>åœ¨PhoneWindowçš„generateLayouté‡Œä¹Ÿæ˜¯æ ¹æ®ä¸»é¢˜ç»™DecorViewåŒ¹é…ä½¿ç”¨çš„XMLæ–‡ä»¶ã€‚è¿™é‡Œæ˜¯ç»™subDecorè¿™ä¸ªåŒ¹é…XMLæ–‡ä»¶ã€‚</p>
<p>æˆ‘ä»¬å†ç»§ç»­çœ‹</p>
<figure data-type="image" tabindex="21"><img src="https://kanyewestforreal.github.io//post-images/1684154573426.png" alt="" loading="lazy"></figure>
<ol>
<li>å…ˆæ˜¯åœ¨åˆšåˆšçœ‹åˆ°çš„subDecorä¸­æ‰¾åˆ°äº†<strong>idä¸º****<code>action_bar_activity_content</code><strong><strong>çš„</strong></strong><code>ContentFrameLayout</code><strong>å®šä¹‰ä¸º</strong><code>contentView</code></strong>ã€‚ç„¶å<strong>é€šè¿‡PW</strong>åœ¨æˆ‘ä»¬ç†Ÿæ‚‰çš„DecorViewä¸­æ‰¾åˆ°äº†<strong>idä¸º****<code>content</code><strong>å®¹å™¨ï¼Œå®šä¹‰ä¸º</strong><code>windowContentView</code></strong>ã€‚</li>
<li>æŠŠ<strong>windowContentViewå†…çš„æ‰€æœ‰View</strong>æ·»åŠ åˆ°<strong>contentView</strong>ä¸­ï¼Œç„¶åæ¸…ç©º<strong>windowContentViewã€‚</strong></li>
<li>æŠŠ<strong>windowContentView</strong>çš„idç½®ç©ºï¼Œå†å°†<strong>contentView</strong>è®¾ç½®idä¸º<strong>content</strong>ã€‚</li>
<li>åˆ é™¤<strong>contentView</strong>çš„å‰æ™¯</li>
<li>å°†<strong>subDecor</strong>ä½œä¸ºå‚æ•°æ‰§è¡ŒPhoneWindowçš„setContentViewæ–¹æ³•ã€‚æ¥ä¸‹æ¥å°±ä¼šé‡å¤å’ŒActivityç±»ä¼¼çš„äº‹ã€‚</li>
</ol>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨Android å¼•å…¥äº† Material Design çš„è®¾è®¡ï¼Œä¸ºäº†æ”¯æŒ Materialï¼ŒColorã€è°ƒè‰²ç‰ˆã€Toolbarç­‰å„ç§æ–°ç‰¹æ€§ï¼ŒAppCompatActivity å°±åº”ç”¨è€Œç”Ÿã€‚AppCompatActivity ä¸ºäº†å…¼å®¹ä»¥å‰çš„ä¸œè¥¿ï¼Œå°±åšäº†<strong>å·æ¢æ¢æŸ±</strong>ï¼Œå…¶ä¸­ä¸€ä¸ªå°±æ˜¯æ›¿æ¢äº†ä»¥å‰ Activity åŠ è½½å†…å®¹å¸ƒå±€çš„çˆ¶å®¹å™¨ï¼Œå³åœ¨<strong>åŸ DecorView çš„ content åŒºåŸŸ</strong>æ·»åŠ ä¸€ä¸ª SubDecorï¼Œæˆ‘ä»¬é€šè¿‡ <strong>setContentView è®¾ç½®çš„å¸ƒå±€æœ€ç»ˆè¢«æ·»åŠ åˆ°è¯¥ SubDecor çš„ content å®¹å™¨ä¸­</strong>ï¼Œè¿™æ ·å®Œæˆå¸ƒå±€å…¼å®¹æ“ä½œã€‚</p>
<p>å‚è€ƒä¸€ä¸‹ä¸‹å›¾ï¼Œå°±èƒ½å¾ˆç®€å•ç†è§£äº†ã€‚</p>
<figure data-type="image" tabindex="22"><img src="https://kanyewestforreal.github.io//post-images/1684154590519.webp" alt="" loading="lazy"></figure>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>äºŒå›¾ä»¥è”½ä¹‹</p>
<figure data-type="image" tabindex="23"><img src="https://kanyewestforreal.github.io//post-images/1684154602552.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="24"><img src="https://kanyewestforreal.github.io//post-images/1684154729983.png" alt="" loading="lazy"></figure>
<h2 id="é—®é¢˜ç­”æ¡ˆ">é—®é¢˜ç­”æ¡ˆ</h2>
<p>//TODO ğŸ˜‹</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p>https://juejin.cn/post/6999144331340677150</p>
<p>https://blog.csdn.net/zxm528/article/details/123134387?spm=1001.2014.3001.5501</p>
<p>https://www.jianshu.com/p/8b7f075be3fc</p>
<p>https://www.cnblogs.com/huansky/p/11911549.html</p>
<p>https://carsonho.blog.csdn.net/article/details/91359867</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%BC%95%E5%85%A5%E4%BB%8Eactvity%E4%BB%8B%E7%BB%8Dview%E7%9A%84%E6%B8%B2%E6%9F%93"><strong>å¼•å…¥ï¼šä»Actvityä»‹ç»Viewçš„æ¸²æŸ“</strong></a></li>
<li><a href="#%E6%B7%B1%E5%85%A5view%E7%9A%84%E5%91%88%E7%8E%B0%E6%B5%81%E7%A8%8B">æ·±å…¥ï¼šViewçš„å‘ˆç°æµç¨‹</a></li>
<li><a href="#%E5%9B%9E%E6%89%A3aca%E4%B8%8Bview%E7%9A%84%E6%B8%B2%E6%9F%93">å›æ‰£ï¼šACAä¸‹Viewçš„æ¸²æŸ“</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
<li><a href="#%E9%97%AE%E9%A2%98%E7%AD%94%E6%A1%88">é—®é¢˜ç­”æ¡ˆ</a></li>
<li><a href="#%E5%8F%82%E8%80%83">å‚è€ƒ</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://kanyewestforreal.github.io/post/custom_view/">
              <h3 class="post-title">
                è‡ªå®šä¹‰Viewå…¥é—¨çŸ¥è¯†
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  This blog is just for me to record the questions, which in my developing.
  <a class="rss" href="https://kanyewestforreal.github.io//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
